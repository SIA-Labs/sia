# SIA Architecture - Submodule vs Project Structure

**Critical Distinction**: The SIA framework is a **git submodule** (`sia/`). It must NOT reference files outside its own directory tree, except when describing structures it will create in the project root.

---

## Directory Layout

```
your-project/                    # Project root (user's repository)
├── .git/
├── .gitmodules                  # Git submodule configuration
├── .sia.detected.yaml           # Auto-generated by installer
├── .github/
│   └── copilot-instructions.md  # Auto-generated by installer
│
├── sia/                         # GIT SUBMODULE (this framework)
│   ├── .git                     # Submodule has its own git
│   ├── README.md
│   ├── core/
│   │   ├── SUPER_AGENT.md       # Framework identity
│   │   └── copilot-instructions.template.md
│   ├── agents/                  # Framework agents (reusable)
│   │   ├── sia.md               # DDD/AI-Native specialist
│   │   ├── spr_pack.md          # SPR compression skill
│   │   ├── repository_guardian.md
│   │   └── research_specialist.md
│   ├── skills/                  # Framework skills (reusable)
│   │   ├── check_complexity.sh
│   │   ├── audit_ddd.py
│   │   └── ...
│   ├── requirements/            # Framework templates
│   │   ├── README.md
│   │   └── _templates/
│   ├── installer/               # Installation scripts
│   │   ├── install.sh
│   │   ├── smart_init.py
│   │   └── auto_discovery.py
│   └── templates/               # Scaffolding templates
│       └── DEFAULT_STACK.md
│
└── .sia/                        # PROJECT-SPECIFIC DATA (created by installer)
    ├── agents/                  # Project agents (specific to this repo)
    │   └── {project_name}.md    # Project SPR (e.g., erp.md, vrp.md)
    ├── requirements/            # Project requirements
    │   ├── REQ-001/
    │   └── _archive/
    ├── skills/                  # Project-specific skills
    ├── knowledge/               # Project knowledge base
    │   ├── active/
    │   └── _archive/
    └── INITIALIZED.md           # Initialization log
```

---

## Reference Rules for Submodule Files

### ✅ ALLOWED References (Inside Submodule)

**Absolute paths from project root**:
```markdown
- `sia/core/SUPER_AGENT.md`
- `sia/agents/sia.md`
- `sia/skills/check_complexity.sh`
- `sia/requirements/README.md`
- `sia/installer/install.sh`
```

**Relative paths from within submodule**:
```python
# In sia/installer/auto_discovery.py
template_path = self.root / "sia/core/copilot-instructions.template.md"
```

### ✅ ALLOWED Descriptions (Structures to be Created)

Files can **describe** (not reference as existing) structures that will be created in the project root:

```markdown
"The installer will create `.sia/agents/{project}.md`"
"Auto-discovery generates `.sia.detected.yaml`"
"Scaffolder creates `backend/src/{project}/domain/`"
```

**Key**: Use future tense ("will create") or conditional ("creates"), not present ("reads", "uses").

### ❌ FORBIDDEN References (Outside Submodule)

**Do NOT reference as existing files**:
```markdown
❌ "Read `.sia/agents/erp.md`"  # Doesn't exist until user initializes
❌ "Use backend/src/erp/domain/entities.py"  # Project-specific
❌ "See requirements/REQ-001.md"  # Old structure (legacy)
❌ "Check .agents/sia.md"  # Legacy structure
```

**Exception**: `auto_discovery.py` **searches** for these (to migrate), which is OK.

---

## Code Examples

### ✅ CORRECT (Submodule-Safe)

```python
# sia/installer/auto_discovery.py
def assemble_instructions(self):
    # Reference template INSIDE submodule
    template_path = self.root / "sia/core/copilot-instructions.template.md"
    
    # Output to project root (OK, we're creating it)
    output_path = self.root / ".github/copilot-instructions.md"
```

```markdown
<!-- sia/README.md -->
## What You Get

After installation, SIA **creates** in your project root:
- `.sia/agents/` - Project-specific agents
- `.sia.detected.yaml` - Auto-detected configuration
```

### ❌ INCORRECT (Broken References)

```python
# sia/installer/some_script.py
def load_project_spr():
    # ❌ WRONG: .sia/ doesn't exist inside submodule
    spr_path = Path("sia/.sia/agents/erp.md")
    content = spr_path.read_text()
```

```markdown
<!-- sia/README.md -->
❌ Read your project SPR in `.sia/agents/erp.md` for details.
✅ The Super Agent will generate `.sia/agents/erp.md` during initialization.
```

---

## Auto-Discovery Strategy

The `auto_discovery.py` script **searches** the project root for existing structures (brownfield), which is correct:

```python
# sia/installer/auto_discovery.py
def detect_spr(self):
    # Search in project root (OK, this is discovery)
    sia_agents_dir = self.root / ".sia" / "agents"  # New structure
    legacy_agents_dir = self.root / ".agents"      # Legacy structure
    
    # Try both locations
    if sia_agents_dir.exists():
        # User already initialized
        pass
    elif legacy_agents_dir.exists():
        # User has legacy structure, suggest migration
        pass
```

**Key**: It **searches** (conditional), doesn't **assume** (required).

---

## Documentation Patterns

### Describing Submodule Files (Absolute Paths)

```markdown
The framework provides:
- `sia/core/SUPER_AGENT.md` - Meta-system definition
- `sia/agents/sia.md` - DDD/AI-Native specialist
- `sia/skills/check_complexity.sh` - Radon complexity analysis
```

### Describing Project Files (Future/Conditional)

```markdown
After initialization, the Super Agent will create:
- `.sia/agents/{project}.md` - Your project's architectural agent
- `.sia.detected.yaml` - Auto-detected configuration
- `.github/copilot-instructions.md` - Enhanced Copilot instructions

If you have a brownfield project, it may detect:
- `backend/src/{project}/domain/` - DDD bounded contexts
- `.agents/` - Legacy structure (will suggest migration)
```

---

## Testing Submodule Isolation

To verify the submodule is self-contained:

```bash
# 1. Clone only the submodule
git clone https://github.com/gpilleux/sia.git sia-test
cd sia-test

# 2. Run installer (should work standalone)
bash installer/install.sh

# 3. Check for broken references
grep -r "\.sia/" --include="*.md" --include="*.py"
grep -r "backend/" --include="*.md" --include="*.py"

# Should only find:
# - References in auto_discovery.py (search logic, OK)
# - Descriptions of structures to create (OK)
# - No "read .sia/..." or "use backend/..." (NOT OK)
```

---

## Submodule Update Protocol

When updating the submodule (`sia/`):

1. **Never commit project-specific files** (`.sia/`, `backend/`, etc.).
2. **Only reference submodule files** in code (absolute paths from project root).
3. **Describe (not reference) project structures** in docs.
4. **Test in isolation** (clone submodule, run installer, check for broken refs).

**Distribution**: Users run `git submodule update --remote sia` to get latest framework.

---

## Common Pitfalls

### ❌ Pitfall 1: Hardcoding Project Structure

```python
# ❌ WRONG (assumes project structure)
domain_path = Path("backend/src/erp/domain")

# ✅ CORRECT (search/discover)
domain_path = self._find_directory_recursive("domain")
```

### ❌ Pitfall 2: Referencing .sia/ as Existing

```markdown
❌ "Edit your `.sia/agents/erp.md` to customize..."
✅ "The Super Agent generates `.sia/agents/erp.md` which you can then customize..."
```

### ❌ Pitfall 3: Documentation in .sia/knowledge/

```bash
# ❌ WRONG location for framework docs
sia/core/SOME_GUIDE.md  # ✅ Correct (framework)
.sia/knowledge/SOME_GUIDE.md  # ❌ Wrong (project-specific)
```

---

## Summary

**Golden Rule**: The `sia/` submodule is a **library**, not a **workspace**. It provides tools and templates, but doesn't assume project structure beyond what it discovers or creates.

**Checklist**:
- [ ] All code references use `sia/` prefix (absolute from project root)
- [ ] Project files (`.sia/`, `backend/`) only in discovery/scaffolding logic
- [ ] Documentation uses future/conditional tense for project structures
- [ ] No hardcoded project paths (use auto-discovery)
- [ ] Submodule can be cloned standalone without errors
